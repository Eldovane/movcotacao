<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MovCotação</title>

    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/css/styles.css"/>
  </head>
  <body>
    <nav class="mobileMenu">
      <button id="closeMenu" type="button">
        <i class="fas fa-times"></i>
      </button>

      <ul>
        <li>
          <a href="/lista">Lista de Cotação</a>
        </li>
        <li>
          <a href="#">Contato</a>
        </li>
        <li>
          <a href="#">Ajuda</a>
        </li>
        <li>
          <a href="/logout">Sair</a>
        </li>
      </ul>
    </nav>

    <section class="quotation">
      <header>
        <h1>Cotação Online</h1>

        <button id="openMenu" class="menuBars" type="button">
          <i class="fas fa-bars"></i>
        </button>

        <div>
          <form id="search">
            <input type="text" placeholder="Buscar no site"/>
            <button type="submit">
              <i class="fas fa-search"></i>
            </button>
          </form>

          <nav>
            <ul>
              <li>
                <a href="/lista">Lista de Cotação</a>
              </li>
              <li>
                <a href="#">Contato</a>
              </li>
              <li>
                <a href="#">Ajuda</a>
              </li>
              <li>
                <a href="/logout">Sair</a>
              </li>
            </ul>
          </nav>
        </div>
      </header>

      <section>
        <div class="background"></div>

        <article>
          <header>
            <div class="profile">
              <img src="/img/noprofile.jpg" alt="No Profile" />

              <div class="profileInfo">
                <strong>{{ company['nome_fantasia'] }}</strong>
                <p>
                  <i class="fas fa-phone-alt"></i>
                  <span>{{ company['telefone'] }}</span>
                </p>
                <p>
                  <i class="fab fa-whatsapp"></i>
                  <span>{{ company['whatsapp'] }}</span>
                </p>
                <p>
                  <i class="far fa-envelope"></i>
                  <span>{{ company['email'] }}</span>
                </p>
              </div>
            </div>

            <div class="quotationNumber">
              <strong>COTAÇÃO - N°</strong>
              <div>
                <p>{{ quotationInfo['numero_cotacao'] }}</p>
              </div>
            </div>

            <div class="dates">
              <div>
                <p>Data de Abertura</p>
                <div class="opening">
                  <img src="/svg/calenderGreen.svg" alt="Calendario icone" />
                  <p>{{ quotationInfo['data_abertura'] }}</p>
                </div>
              </div>

              <div>
                <p>Data de Fechamento</p>
                <div class="closing">
                  <img src="/svg/calenderRed.svg" alt="Calendario icone" />
                  <p>{{ quotationInfo['data_validade'] }}</p>
                </div>
              </div>
            </div>
          </header>

          <div class="quotes">
            <table>
              <thead>
                <tr>
                  <th>Cód. SKU</th>
                  <th>Cód. Produto</th>
                  <th>Cód. Referência</th>
                  <th>Desc. Produto</th>
                  <th>Qtd. a Comparar</th>
                  <th>Oferta (R$)</th>
                  <th>Observação</th>
                </tr>
              </thead>

              <tbody>
                {% for quotation in listQuotesOpening %}
                  <tr>
                    <td data-label="Cód. SKU">
                      <div>{{quotation['id_sku']}}</div>
                    </td>
                    <td data-label="Cód. Produto">
                      <div>{{quotation['id_produto']}}</div>
                    </td>
                    <td data-label="Cód. Referência">
                      <div>{{quotation['id_referencia']}}</div>
                    </td>
                    <td data-label="Desc. Produto">
                      <div>{{quotation['descricao_produto']}}</div>
                    </td>
                    <td id="" data-label="Qtd. a Comparar">
                      <div>{{quotation['quantidade_produto']}}</div>
                    </td>
                    <td data-label="Oferta (R$)">
                      <div class="inputContainer">
                        <input
                          type="text"
                          placeholder="0,00"
                          value="{{quotation['valor_ofertado']}}"
                        />
                      </div>
                    </td>
                    <td data-label="Observação">
                      <div class="inputContainer">
                        <input
                          type="text"
                          placeholder="Texto de observação"
                          value="{{quotation['observacao']}}"
                        />
                      </div>
                    </td>
                  </tr>
                {% else %}
                  <strong>Nenhum item para ser cotado</strong>
                {% endfor %}
              </tbody>
            </table>

            <div class="pagination">
              <button>
                <span>Anterior</span>
                <i class="fas fa-caret-left"></i>
              </button>

              <p>Página 01</p>

              <button>
                <span>Próxima</span>
                <i class="fas fa-caret-right"></i>
              </button>
            </div>

            <div class="btn_group">
              <button id="saveQuotationItems">Salvar</button>
              <button id="sendQuotationItems">Enviar cotação</button>
            </div>
          </div>
        </article>
      </section>
    </section>

    <script
      src="https://kit.fontawesome.com/c1f9e19d38.js"
      crossorigin="anonymous"
    ></script>

    <script>
      document.getElementById('openMenu').addEventListener('click', () => {
        document.querySelector('.mobileMenu').style.display = 'flex';
      });

      document.getElementById('closeMenu').addEventListener('click', () => {
        document.querySelector('.mobileMenu').style.display = 'none';
      });
    </script>

    <script>
      function saveQuotationItems(is_closing = false) {
        const table = document.querySelector('table');

        const rows = Array.prototype.slice.call(table.rows);

        rows.shift();

        const quotationItems = rows.map(row => {
          return {
            id_sku: Number(row.cells[0].children[0].innerText),
            id_produto: Number(row.cells[1].children[0].innerText),
            id_referencia: row.cells[2].children[0].innerText,
            descricao_produto: row.cells[3].children[0].innerText,
            quantidade_produto: Number(row.cells[4].children[0].innerText),
            valor_ofertado: Number(row.cells[5].children[0].children[0].value),
            observacao: row.cells[6].children[0].children[0].value,
          }
        });

        const formSaveQuotationItems = document.createElement('form');
        formSaveQuotationItems.action = '/save_quotation_items';
        formSaveQuotationItems.method = 'POST'
        formSaveQuotationItems.style.display = 'none';

        let index = 0;

        console.log({ quotationItems });

        quotationItems.forEach(quotationItem => {
          const keys = Object.keys(quotationItem);

          keys.forEach(key => {
            const input = document.createElement('input');

            input.name = `quotationItems[${index}][${key}]`;
            input.value = quotationItem[key];

            formSaveQuotationItems.append(input);
          });

          index += 1;
        });

        const input = document.createElement('input');
        input.name = 'quotationNumber';
        input.value = '{{ quotationInfo["numero_cotacao"] }}';

        const inputCheck = document.createElement('input');
        inputCheck.name = "is_closing";
        inputCheck.type = "checkbox";
        inputCheck.checked = is_closing;

        formSaveQuotationItems.append(input);
        formSaveQuotationItems.append(inputCheck);

        document.body.append(formSaveQuotationItems);
        formSaveQuotationItems.submit();
      }

      document
        .getElementById('saveQuotationItems')
        .addEventListener('click', () => {
          saveQuotationItems();
        });

      document
        .getElementById('sendQuotationItems')
        .addEventListener('click', () => {
          saveQuotationItems(true);
        });
    </script>
  </body>
</html>
